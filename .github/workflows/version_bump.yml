name: bump-version-on-merge

on:
  pull_request:
    types: [closed]

jobs:
  bump:
    if: >-
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.user.login != 'github-actions[bot]' &&
      !startsWith(github.event.pull_request.title, 'chore: bump version')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine bump kind from PR title
        id: meta
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR title: $TITLE"

          TYPE="${TITLE%%:*}"
          echo "Raw type: $TYPE"

          if [[ "$TYPE" == *"!" ]]; then
            BASE_TYPE="${TYPE%!}"
            echo "Base type (without !): $BASE_TYPE"
            BUMP_KIND="major"
          else
            BASE_TYPE="$TYPE"
            if [[ "$BASE_TYPE" == "feat" ]]; then
              BUMP_KIND="minor"
            else
              BUMP_KIND="patch"
            fi
          fi

          echo "bump_kind=$BUMP_KIND" >> "$GITHUB_OUTPUT"

      - name: Bump version in version.txt
        id: bump
        run: |
          BUMP_KIND="${{ steps.meta.outputs.bump_kind }}"
          echo "Bump kind: $BUMP_KIND"

          mkdir -p Assets/Resources
          VERSION_FILE="Assets/Resources/version.txt"

          if [ ! -f "$VERSION_FILE" ]; then
            echo "0.0.1" > "$VERSION_FILE"
          fi

          VERSION=$(cat "$VERSION_FILE" | tr -d ' \n\r')
          echo "Current version: $VERSION"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "$BUMP_KIND" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > "$VERSION_FILE"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create version bump pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: bump version to ${{ steps.bump.outputs.version }}"
          branch: "version-bump/${{ steps.bump.outputs.version }}"
          title: "chore: bump version to ${{ steps.bump.outputs.version }}"
          body: "Automatic version bump to ${{ steps.bump.outputs.version }} based on PR #${{ github.event.pull_request.number }}."
          labels: |
            chore
            version-bump
          delete-branch: true

      - name: Merge version bump pull request
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = Number(process.env.PR_NUMBER);

            core.info(`Merging version bump PR #${prNumber}`);

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: prNumber,
              merge_method: 'merge', // або 'squash', якщо хочеш
            });
